name: Inject ICA Tweak

# NOTE: This workflow injects the ApolloICA tweak in the Apollo IPA.
#
# Tweak created by @JeffreyCA - https://github.com/JeffreyCA


on:
  workflow_dispatch:
    inputs:
      apollo_ipa_url:
        description: 'Direct link to Apollo IPA'
        default: 'https://github.com/BackyarDEV/apollo-ica-helper/releases/download/BaseIPA/Apollo_1.15.11_LG.ipa'
        required: true
        type: string
      release_tag:
        description: 'ApolloICA Tweak Release tag to download the dylibs from (e.g. 1.2.6)'
        required: true
        type: string
      ica_patch_ipa_url:
        description: 'ApolloICA Tweak URL (replace this with a working link if the workflow fails)'
        required: true
        default: 'https://github.com/JeffreyCA/Apollo-ImprovedCustomApi/releases/download/v-Z-version-Z-/ca.jeffrey.apollo-improvedcustomapi_-Z-version-Z-_iphoneos-arm64_rootless.deb'
        type: string
      bundle_id:
        description: "BundleID (Optional)"
        default: "com.christianselig.Apollo"
        required: true
        type: string
      upload_catbox:
        description: 'Whether to upload the patched IPA to Catbox (true/false)'
        required: true
        default: true
        type: boolean

env:
  RELEASE_INFO_URL: "https://api.github.com/repos/JeffreyCA/Apollo-ImprovedCustomApi/releases/tags/v${{ github.event.inputs.release_tag }}"

jobs:
  patch:
    # Ensure this job only runs for manual (workflow_dispatch) triggers as an extra safety guard
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Fetch Release Notes
        id: fetch_release_notes
        run: |
          echo "Fetching release notes from: $RELEASE_INFO_URL"
          
          RELEASE_INFO=$(curl --silent --show-error --fail -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" --request GET --url "$RELEASE_INFO_URL")
          
          RELEASE_NOTES=$(printf '%s' "$RELEASE_INFO" | python3 -c "import sys,json; print(json.load(sys.stdin).get('body',''))")
          
          if [[ -z "$RELEASE_NOTES" ]]; then
            echo "::error::Failed to extract 'body' from release JSON."
            exit 1
          fi

          echo "Fetched release desc: ${RELEASE_NOTES}"
          echo "release_notes=${RELEASE_NOTES}" >> $GITHUB_OUTPUT

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install make ldid

      - name: Set PATH environment variable
        run: echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Install cyan
        run: pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Download and validate IPA
        run: |
          wget "${{ github.event.inputs.apollo_ipa_url }}" --no-verbose -O ${{ github.workspace }}/Apollo.ipa

          file_type=$(file --mime-type -b ${{ github.workspace }}/Apollo.ipa)

          if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" ]]; then
            echo "::error::Validation failed: The downloaded file is not a valid IPA. Detected type: $file_type."
            exit 1
          fi

      - name: Download and validate Apollo ICA tweak
        run: |
          URL="${{ github.event.inputs.ica_patch_ipa_url }}"
          RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          NEW_URL="${URL//-Z-version-Z-/${RELEASE_TAG}}"
          echo "Downloading Apollo ICA Tweak from: ${NEW_URL}"
          wget "${NEW_URL}" --no-verbose -O ${{ github.workspace }}/Apollo-ImprovedCustomApi.deb

          file_type=$(file --mime-type -b ${{ github.workspace }}/Apollo-ImprovedCustomApi.deb)

          if [[ "$file_type" != "application/vnd.debian.binary-package" ]]; then
            echo "::error::Validation failed: The file is not a valid DEB file. Detected type: $file_type."
            exit 1
          fi

      - name: Inject Apollo IPA Tweak
        id: inject_tweak
        run: |
          OUTPUT_IPA_NAME="Apollo-Patched_${{ github.event.inputs.release_tag }}.ipa"
          cyan -i Apollo.ipa -o "${OUTPUT_IPA_NAME}" -f Apollo-ImprovedCustomApi.deb -n "Apollo" -b ${{ github.event.inputs.bundle_id }}
          IPA_SIZE=$(stat -f%z "${OUTPUT_IPA_NAME}")
          echo "Patched IPA Size: $(stat -f%z ${OUTPUT_IPA_NAME})"
          
          echo "patched_ipa_name=${OUTPUT_IPA_NAME}" >> $GITHUB_OUTPUT
          echo "patched_ipa_size=${IPA_SIZE}" >> $GITHUB_OUTPUT

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.inject_tweak.outputs.patched_ipa_name }}
          path: ${{ steps.inject_tweak.outputs.patched_ipa_name }}

      - name: Upload IPA to Catbox
        id: upload_catbox
        if: ${{ github.event.inputs.upload_catbox }}
        env:
          CATBOX_USER_HASH: ${{ secrets.CATBOX_USER_HASH }}
        run: |
          if [[ -z "$CATBOX_USER_HASH" ]]; then
            echo "::error::CATBOX_USER_HASH secret is not configured."
            exit 1
          fi
          
          if [[ ! -f "./scripts/catbox.sh" ]]; then
            echo "Can't access catbox.sh script at expected path: ./scripts/catbox.sh."
            exit 1
          fi
          
          chmod +x ./scripts/catbox.sh
          
          echo "Uploading patched IPA to Catbox named: ${{ steps.inject_tweak.outputs.patched_ipa_name }}"
          
          ./scripts/catbox.sh file "${{ steps.inject_tweak.outputs.patched_ipa_name }}" -u "$CATBOX_USER_HASH"
          
          CATBOX_LINK=$(cat catbox_link.txt)  
          echo "Catbox file link: ${CATBOX_LINK}"
          
          if [[ ! "$CATBOX_LINK" =~ ^https ]]; then
            echo "::error::Unexpected response from Catbox upload: ${CATBOX_LINK}"
            exit 1
          fi

          echo "catbox_url=${CATBOX_LINK}" >> "$GITHUB_OUTPUT"
          echo "Uploaded IPA to Catbox: ${CATBOX_LINK}"

      - name: Check out repository for push
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Update repo.json and push
        id: update_repo_json
        env:
          RELEASE_TAG: ${{ github.event.inputs.release_tag }}
          CATBOX_URL: ${{ steps.upload_catbox.outputs.catbox_url }}
          RELEASE_NOTES: ${{ steps.fetch_release_notes.outputs.release_notes }}
          SIZE: ${{ steps.inject_tweak.outputs.patched_ipa_size }}
        run: |
          set -e

          # configure commit author
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # run the update script
          python3 scripts/update_repo_json.py -t "${RELEASE_TAG}" -u "${CATBOX_URL}" -n "${RELEASE_NOTES}" -s "${SIZE}"

          # commit and push only if there are changes
          git add repo.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update repo.json last_release to ${RELEASE_TAG}"
            git push
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2.0.8
        with:
          draft: false
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Apollo ICA - v${{ github.event.inputs.release_tag }}
          body: ${{ github.event.inputs.upload_catbox && format('- {0} - [Catbox Link]({1})', steps.fetch_release_notes.outputs.release_notes, steps.upload_catbox.outputs.catbox_url) || format('- {0}', steps.fetch_release_notes.outputs.release_notes) }}
          files: |
            ${{ steps.inject_tweak.outputs.patched_ipa_name }}
          prerelease: false
